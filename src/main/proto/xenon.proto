syntax = "proto3";

option java_package = "nl.esciencecenter.xenon.grpc";
option java_outer_classname = "XenonProto";

package xenon;

message Empty {

}

message Properties {
    map<string, string> properties = 1;
}

message PropertyDescription {
    string name = 1;
    string description = 2;
    string defaultValue = 3;
    enum Type {
        STRING = 0;
        BOOLEAN = 1;
        INTEGER = 2;
        DOUBLE = 3;
        LONG = 4;
        SIZE = 5;
        NATURAL = 6;
    }
    Type type = 4;
}

message PropertyDescriptions {
    repeated PropertyDescription properties = 1;
}

message SchedulerAdaptorDescription {
    string name = 1;
    string description = 2;
    repeated string supportedLocations = 3;
    repeated PropertyDescription supportedProperties = 4;
    bool isEmbedded = 5;
    bool supportsInteractive = 6;
    bool supportsBatch = 7;
}

message SchedulerAdaptorDescriptions {
    repeated SchedulerAdaptorDescription descriptions = 1;
}

message FileSystemAdaptorDescription {
    string name = 1;
    string description = 2;
    repeated string supportedLocations = 3;
    repeated PropertyDescription supportedProperties = 4;
    // copy between remote filesystems directly, without passing bytes through local process
    bool supportsThirdPartyCopy = 5;
    bool canCreateSymboliclinks = 6;
    bool canReadSymboliclinks = 7;
    bool isConnectionLess = 8;
}

message FileSystemAdaptorDescriptions {
    repeated FileSystemAdaptorDescription descriptions = 1;
}

message AdaptorName {
    string name = 1;
}

message CertificateCredential {
    // Path to certificate file
    string certfile = 1;
    string passphrase = 2;
    string username = 3;
}

message PasswordCredential {
    string username = 1;
    string password = 2;
}

message DefaultCredential {
    string username = 1;
}

message CreateFileSystemRequest {
    string adaptor = 1;
    string location = 2;
    map<string, string> properties = 3;
    oneof credential {
        CertificateCredential certificateCred = 4;
        PasswordCredential passwordCred = 5;
        DefaultCredential defaultCred = 6;
    }
}

// Handle for Xenon FileSystem object
message FileSystem {
    string id = 1;
    // name of the adaptor that created this FileSystem
    string adaptor_name = 2;
}

message FileSystems {
    repeated FileSystem filesystems = 1;
}

message Path {
    string path = 1;
    // Separator used in path. Defaults to `/`
    string separator = 2;
}

message FileSystemPath {
    FileSystem filesystem = 1;
    Path path = 2;
}

message DeleteRequest {
    FileSystem filesystem = 1;
    Path path = 2;
    bool recursive = 3;
}

message CopyRequest {
    FileSystem filesystem = 1;
    Path source = 2;
    FileSystem destination_filesystem = 3;
    Path destination = 4;
    enum CopyMode {
        CREATE = 0;
        REPLACE = 1;
        IGNORE = 2;
    }
    CopyMode mode = 5;
    bool recursive = 6;
}

message RenameRequest {
    FileSystem filesystem = 1;
    Path source = 2;
    Path target = 3;
}

message CreateSymbolicLinkRequest {
    FileSystem filesystem = 1;
    Path link = 2;
    Path target = 3;
}

message CopyOperation {
    string id = 1;
    FileSystem filesystem = 2;
}

message CopyOperationWithTimeout {
    string id = 1;
    FileSystem filesystem = 2;
    uint64 timeout = 3;
}

message CopyStatus {
    CopyOperation copyOperation = 1;
    uint64 bytesCopied = 2;
    uint64 bytesToCopy = 3;
    bool done = 4;
    bool running = 5;
    string state = 6;
    string error = 7;
}

enum PosixFilePermission {
    NONE = 0;
    OWNER_READ = 1;
    OWNER_WRITE = 2;
    OWNER_EXECUTE = 3;
    GROUP_READ = 4;
    GROUP_WRITE = 5;
    GROUP_EXECUTE = 6;
    OTHERS_READ = 7;
    OTHERS_WRITE = 8;
    OTHERS_EXECUTE = 9;
}

message PathAttributes {
    FileSystem filesystem = 1;
    Path path = 2;
    uint64 creationTime = 3;
    string group = 4;
    bool isDirectory = 5;
    bool isExecutable = 6;
    bool isHidden = 7;
    bool isOther = 8;
    bool isReadable = 9;
    bool isRegularFile = 10;
    bool isSymbolicLink = 11;
    bool isWritable = 12;
    uint64 lastAccessTime = 13;
    uint64 lastModifiedTime = 14;
    string owner = 15;
    repeated PosixFilePermission permissions = 16;
    uint64 size = 17;
}

message SetPosixFilePermissionsRequest {
    FileSystem filesystem = 1;
    Path path = 2;
    repeated PosixFilePermission permissions = 3;
}

message ReadFromFileResponse {
    bytes buffer = 1;
}

message WriteToFileRequest {
    FileSystem filesystem = 1;
    Path path = 2;
    bytes buffer = 3;
    uint64 size = 4;
}

message AppendToFileRequest {
    FileSystem filesystem = 1;
    Path path = 2;
    bytes buffer = 3;
}

message ListRequest {
    FileSystem filesystem = 1;
    Path dir = 2;
    bool recursive = 3;
}

message CreateSchedulerRequest {
    string adaptor = 1;
    string location = 2;
    map<string, string> properties = 3;
    oneof credential {
        CertificateCredential certificateCred = 4;
        PasswordCredential passwordCred = 5;
        DefaultCredential defaultCred = 6;
    }
}

// Handle for Xenon Scheduler object
message Scheduler {
    string id = 1;
}

message Schedulers {
    repeated Scheduler schedulers = 1;
}

message JobDescription {
    string executable = 1;
    repeated string arguments = 2;
    string workingDirectory = 3;
    map<string, string> environment = 4;
    string queueName = 5;
    uint32 maxTime = 6;
    uint32 nodeCount = 7;
    uint32 processesPerNode = 8;
    bool startSingleProcess = 9;
    string stderr = 10;
    string stdin = 11;
    string stdout = 12;
    // In Xenon named jobOptions
    map<string, string> options = 13;
}

message SubmitBatchJobRequest {
    Scheduler scheduler = 1;
    JobDescription description = 2;
}

message SubmitInteractiveJobRequest {
    Scheduler scheduler = 1;
    JobDescription description = 2;
    bytes stdin = 3;
}

message Job {
    string id = 1;
}

message SchedulerJob {
    Scheduler scheduler = 1;
    Job job = 2;
}

message Jobs {
    Scheduler scheduler = 1;
    repeated Job jobs = 2;
}

message JobWithTimeout {
    Scheduler scheduler = 1;
    Job job = 2;
    uint64 timeout = 3;
}

message Queue {
    string name = 1;
}

message Queues {
    repeated string name = 1;
}

message SchedulerAndQueues {
    Scheduler scheduler = 1;
    repeated string queues = 2;
}

message SchedulerAndQueue {
    Scheduler scheduler = 1;
    string queue = 2;
}

message JobStatus {
    Scheduler scheduler = 1;
    Job job = 2;
    string state = 3;
    bool running = 4;
    bool done = 5;
    map<string, string> schedulerSpecificInformation = 6;
    int32 exitCode = 7;
    string errorMessage = 8;
    enum ErrorType {
        EMPTY = 0;
        // NoSuchJobException
        NOT_FOUND = 1;
        // JobCanceledException
        CANCELLED = 2;
        // XenonException
        XENON = 3;
        // IOException
        IO = 4;
        OTHER = 5;
    }
    ErrorType errorType = 9;
}

message JobStatuses {
    repeated JobStatus statuses = 1;
}

message QueueStatus {
    // In Xenon named queueName
    string name = 1;
    Scheduler scheduler = 2;
    map<string, string> schedulerSpecificInformation = 3;
    string error = 4;
}

message QueueStatuses {
    repeated QueueStatus statuses = 1;
}

message SubmitInteractiveJobResponse {
    Scheduler scheduler = 1;
    Job job = 2;
    bytes stdout = 3;
    bytes stderr = 4;
}

message Is {
    bool value = 1;
}

// XenonFiles represents the Xenon nl.esciencecenter.xenon.filesystems.FileSystem class.
// This interface contains various methods for creating and closing FileSystems, creating Paths and operations on these Paths.
service XenonFileSystems {
    // Gives a list of the descriptions of the available adaptors.
    rpc getAdaptorDescriptions(Empty) returns (FileSystemAdaptorDescriptions) {}
    // Gives the description of the adaptor with the given name.
    rpc getAdaptorDescription(AdaptorName) returns (FileSystemAdaptorDescription) {}
    rpc create(CreateFileSystemRequest) returns (FileSystem) {}
    rpc createDirectories(FileSystemPath) returns (Empty) {}
    rpc createDirectory(FileSystemPath) returns (Empty) {}
    rpc createFile(FileSystemPath) returns (Empty) {}
    rpc createSymbolicLink(CreateSymbolicLinkRequest) returns (Empty) {}
    rpc copy(CopyRequest) returns (CopyOperation) {}
    rpc cancel(CopyOperation) returns (CopyStatus) {}
    rpc getStatus(CopyOperation) returns (CopyStatus) {}
    rpc rename(RenameRequest) returns (Empty) {}
    rpc delete(DeleteRequest) returns (Empty) {}
    rpc exists(FileSystemPath) returns (Is) {}
    rpc readFromFile(FileSystemPath) returns (stream ReadFromFileResponse) {}
    rpc writeToFile(stream WriteToFileRequest) returns (Empty) {}
    rpc appendToFile(stream AppendToFileRequest) returns (Empty) {}
    rpc list(ListRequest) returns (stream PathAttributes) {}
    rpc getAttributes(FileSystemPath) returns (PathAttributes) {}
    rpc getWorkingDirectory(FileSystem) returns (FileSystemPath) {}
    rpc setWorkingDirectory(FileSystemPath) returns (Empty) {}
    rpc setPosixFilePermissions(SetPosixFilePermissionsRequest) returns (Empty) {}
    rpc readSymbolicLink(FileSystemPath) returns (FileSystemPath) {}
    rpc isOpen(FileSystem) returns (Is) {}
    // Closes a filestem, any actions running it with this filestystem will be terminated, will also forget the filesystem
    // Any pending/running copy operations will be killed
    rpc close(FileSystem) returns (Empty) {}
    rpc waitUntilDone(CopyOperationWithTimeout) returns (CopyStatus) {}
    // Returns filesystems for all local drives
    rpc localFileSystems(Empty) returns (FileSystems) {}
    // List the created filesystems
    // Specific to grpc, not part of Xenon library
    rpc listFileSystems(Empty) returns (FileSystems) {}
}

// The Jobs API of Xenon. This interface creates various methods for creating and closing Schedulers, submitting jobs, and retrieving information about schedulers and jobs.
service XenonSchedulers {
    rpc getAdaptorDescriptions(Empty) returns (SchedulerAdaptorDescriptions) {}
    rpc getAdaptorDescription(AdaptorName) returns (SchedulerAdaptorDescription) {}
    rpc create(CreateSchedulerRequest) returns (Scheduler) {}
    rpc submitBatchJob(SubmitBatchJobRequest) returns (SchedulerJob) {}
    // The first response message in the response stream will contain the job identifier and empty stdout and stdout.
    // Other response messages will also contain the job identifier and filled stdout and/or stderr.
    rpc submitInteractiveJob(stream SubmitInteractiveJobRequest) returns (stream SubmitInteractiveJobResponse) {}
    rpc getQueues(Scheduler) returns (Queues) {}
    rpc getDefaultQueueName(Scheduler) returns (Queue) {}
    rpc getJobs(SchedulerAndQueues) returns (Jobs) {}
    rpc getJobStatus(SchedulerJob) returns (JobStatus) {}
    rpc getJobStatuses(Jobs) returns (JobStatuses) {}
    rpc getQueueStatus(SchedulerAndQueue) returns (QueueStatus) {}
    rpc getQueueStatuses(SchedulerAndQueues) returns (QueueStatuses) {}
    rpc waitUntilDone(JobWithTimeout) returns (JobStatus) {}
    rpc waitUntilRunning(JobWithTimeout) returns (JobStatus) {}
    rpc isOpen(Scheduler) returns (Is) {}
    rpc cancelJob(SchedulerJob) returns (JobStatus) {}
    // Close scheduler and forget it
    // If scheduler is embedded then any pending/running jobs will be killed
    rpc close(Scheduler) returns (Empty) {}
    rpc localScheduler(Empty) returns (Scheduler) {}
    // List the created schedulers
    // Specific to grpc, not part of Xenon library
    rpc listSchedulers(Empty) returns (Schedulers) {}
}


