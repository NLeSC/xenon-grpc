syntax = "proto3";

option java_package = "nl.esciencecenter.xenon.grpc";
option java_outer_classname = "XenonProto";

package xenon;

message Empty {

}

message Properties {
    map<string, string> properties = 1;
}

message PropertyDescription {
    string name = 1;
    string description = 2;
    string default_value = 3;
    enum Type {
        STRING = 0;
        BOOLEAN = 1;
        INTEGER = 2;
        DOUBLE = 3;
        LONG = 4;
        SIZE = 5;
        NATURAL = 6;
    }
    Type type = 4;
}

message PropertyDescriptions {
    repeated PropertyDescription properties = 1;
}

message SchedulerAdaptorDescription {
    string name = 1;
    string description = 2;
    repeated string supported_locations = 3;
    repeated PropertyDescription supported_properties = 4;
    bool is_embedded = 5;
    bool supports_interactive = 6;
    bool supports_batch = 7;
}

message SchedulerAdaptorDescriptions {
    repeated SchedulerAdaptorDescription descriptions = 1;
}

message FileSystemAdaptorDescription {
    string name = 1;
    string description = 2;
    repeated string supported_locations = 3;
    repeated PropertyDescription supported_properties = 4;
    // copy between remote filesystems directly, without passing bytes through local process
    bool supports_third_party_copy = 5;
    bool can_create_symboliclinks = 6;
    bool can_read_symboliclinks = 7;
    bool is_connectionless = 8;
}

message FileSystemAdaptorDescriptions {
    repeated FileSystemAdaptorDescription descriptions = 1;
}

message AdaptorName {
    string name = 1;
}

message CertificateCredential {
    // Path to certificate file
    string certfile = 1;
    string passphrase = 2;
    string username = 3;
}

message PasswordCredential {
    string username = 1;
    string password = 2;
}

message DefaultCredential {
    string username = 1;
}

message CreateFileSystemRequest {
    string adaptor = 1;
    string location = 2;
    map<string, string> properties = 3;
    oneof credential {
        CertificateCredential certificate_credential = 4;
        PasswordCredential password_credential = 5;
        DefaultCredential default_credential = 6;
    }
}

// Handle for Xenon FileSystem object
message FileSystem {
    string id = 1;
    // name of the adaptor that created this FileSystem
    string adaptor_name = 2;
}

message FileSystems {
    repeated FileSystem filesystems = 1;
}

message Path {
    string path = 1;
    // Separator used in path. Defaults to `/`
    string separator = 2;
}

message PathRequest {
    FileSystem filesystem = 1;
    Path path = 2;
}

message DeleteRequest {
    FileSystem filesystem = 1;
    Path path = 2;
    bool recursive = 3;
}

message CopyRequest {
    FileSystem filesystem = 1;
    Path source = 2;
    FileSystem destination_filesystem = 3;
    Path destination = 4;
    enum CopyMode {
        CREATE = 0;
        REPLACE = 1;
        IGNORE = 2;
    }
    CopyMode mode = 5;
    bool recursive = 6;
}

message RenameRequest {
    FileSystem filesystem = 1;
    Path source = 2;
    Path target = 3;
}

message CreateSymbolicLinkRequest {
    FileSystem filesystem = 1;
    Path link = 2;
    Path target = 3;
}

message CopyOperation {
    string id = 1;
}

message CopyOperationRequest {
    FileSystem filesystem = 1;
    CopyOperation copy_operation = 2;
}

message WaitUntilDoneRequest {
    FileSystem filesystem = 1;
    CopyOperation copy_operation = 2;
    uint64 timeout = 3;
}

message CopyStatus {
    CopyOperation copy_operation = 1;
    uint64 bytes_copied = 2;
    uint64 bytes_to_copy = 3;
    bool done = 4;
    bool running = 5;
    string state = 6;
    string error_message = 7;
    enum ErrorType {
        // No error
        EMPTY = 0;
        // NoSuchPathException
        NOT_FOUND = 1;
        // CopyCancelledException
        CANCELLED = 2;
        // PathAlreadyExistsException
        ALREADY_EXISTS = 3;
        // NotConnectedException
        NOT_CONNECTED = 4;
        // XenonException
        XENON = 5;
        // IOException
        IO = 6;
        OTHER = 7;
    }
    ErrorType error_type = 8;
}

enum PosixFilePermission {
    NONE = 0;
    OWNER_READ = 1;
    OWNER_WRITE = 2;
    OWNER_EXECUTE = 3;
    GROUP_READ = 4;
    GROUP_WRITE = 5;
    GROUP_EXECUTE = 6;
    OTHERS_READ = 7;
    OTHERS_WRITE = 8;
    OTHERS_EXECUTE = 9;
}

message PathAttributes {
    Path path = 1;
    uint64 creation_time = 2;
    string group = 3;
    bool is_directory = 4;
    bool is_executable = 5;
    bool is_hidden = 6;
    bool is_other = 7;
    bool is_readable = 8;
    bool is_regular = 9;
    bool is_symbolic_link = 10;
    bool is_writable = 11;
    uint64 last_access_time = 12;
    uint64 last_modified_time = 13;
    string owner = 14;
    repeated PosixFilePermission permissions = 15;
    uint64 size = 16;
}

message SetPosixFilePermissionsRequest {
    FileSystem filesystem = 1;
    Path path = 2;
    repeated PosixFilePermission permissions = 3;
}

message ReadFromFileResponse {
    bytes buffer = 1;
}

message WriteToFileRequest {
    FileSystem filesystem = 1;
    Path path = 2;
    bytes buffer = 3;
    uint64 size = 4;
}

message AppendToFileRequest {
    FileSystem filesystem = 1;
    Path path = 2;
    bytes buffer = 3;
}

message ListRequest {
    FileSystem filesystem = 1;
    Path dir = 2;
    bool recursive = 3;
}

message CreateSchedulerRequest {
    string adaptor = 1;
    string location = 2;
    map<string, string> properties = 3;
    oneof credential {
        CertificateCredential certificate_credential = 4;
        PasswordCredential password_credential = 5;
        DefaultCredential default_credential = 6;
    }
}

// Handle for Xenon Scheduler object
message Scheduler {
    string id = 1;
}

message Schedulers {
    repeated Scheduler schedulers = 1;
}

message JobDescription {
    string executable = 1;
    repeated string arguments = 2;
    string working_directory = 3;
    map<string, string> environment = 4;
    string queue_name = 5;
    uint32 max_time = 6;
    uint32 node_count = 7;
    uint32 processes_per_node = 8;
    bool start_single_process = 9;
    string stderr = 10;
    string stdin = 11;
    string stdout = 12;
    // In Xenon named jobOptions
    map<string, string> options = 13;
}

message SubmitBatchJobRequest {
    Scheduler scheduler = 1;
    JobDescription description = 2;
}

message SubmitInteractiveJobRequest {
    Scheduler scheduler = 1;
    JobDescription description = 2;
    bytes stdin = 3;
}

message Job {
    string id = 1;
}

message JobRequest {
    Scheduler scheduler = 1;
    Job job = 2;
}

message Jobs {
    Scheduler scheduler = 1;
    repeated Job jobs = 2;
}

message WaitRequest {
    Scheduler scheduler = 1;
    Job job = 2;
    uint64 timeout = 3;
}

message Queue {
    string name = 1;
}

message Queues {
    repeated string name = 1;
}

message SchedulerAndQueues {
    Scheduler scheduler = 1;
    repeated string queues = 2;
}

message GetQueueStatusRequest {
    Scheduler scheduler = 1;
    string queue = 2;
}

message JobStatus {
    string state = 1;
    bool running = 2;
    bool done = 3;
    map<string, string> scheduler_specific_information = 4;
    int32 exit_code = 5;
    string error_message = 6;
    enum ErrorType {
        // No error
        EMPTY = 0;
        // NoSuchJobException
        NOT_FOUND = 1;
        // JobCanceledException
        CANCELLED = 2;
        // NotConnectedException
        NOT_CONNECTED = 3;
        // XenonException
        XENON = 4;
        // IOException
        IO = 5;
        OTHER = 6;
    }
    ErrorType error_type = 7;
}

message JobStatuses {
    repeated JobStatus statuses = 1;
}

message QueueStatus {
    // In Xenon named queueName
    string name = 1;
    map<string, string> scheduler_specific_information = 2;
    string error_message = 3;
    enum ErrorType {
        // No error
        EMPTY = 0;
        // NoSuchQueueException
        NOT_FOUND = 1;
        // NotConnectedException
        NOT_CONNECTED = 2;
        // XenonException
        XENON = 3;
        // IOException
        IO = 4;
        OTHER = 5;
    }
    ErrorType error_type = 4;
}

message QueueStatuses {
    repeated QueueStatus statuses = 1;
}

message SubmitInteractiveJobResponse {
    Job job = 1;
    bytes stdout = 2;
    bytes stderr = 3;
}

message Is {
    bool value = 1;
}

// XenonFiles represents the Xenon nl.esciencecenter.xenon.filesystems.FileSystem class.
// This interface contains various methods for creating and closing FileSystems, creating Paths and operations on these Paths.
service FileSystemService {
    // Gives a list of the descriptions of the available adaptors.
    rpc getAdaptorDescriptions(Empty) returns (FileSystemAdaptorDescriptions) {}
    // Gives the description of the adaptor with the given name.
    rpc getAdaptorDescription(AdaptorName) returns (FileSystemAdaptorDescription) {}
    rpc create(CreateFileSystemRequest) returns (FileSystem) {}
    rpc createDirectories(PathRequest) returns (Empty) {}
    rpc createDirectory(PathRequest) returns (Empty) {}
    rpc createFile(PathRequest) returns (Empty) {}
    rpc createSymbolicLink(CreateSymbolicLinkRequest) returns (Empty) {}
    rpc copy(CopyRequest) returns (CopyOperation) {}
    rpc cancel(CopyOperationRequest) returns (CopyStatus) {}
    rpc getStatus(CopyOperationRequest) returns (CopyStatus) {}
    rpc rename(RenameRequest) returns (Empty) {}
    rpc delete(DeleteRequest) returns (Empty) {}
    rpc exists(PathRequest) returns (Is) {}
    rpc readFromFile(PathRequest) returns (stream ReadFromFileResponse) {}
    rpc writeToFile(stream WriteToFileRequest) returns (Empty) {}
    rpc appendToFile(stream AppendToFileRequest) returns (Empty) {}
    rpc list(ListRequest) returns (stream PathAttributes) {}
    rpc getAttributes(PathRequest) returns (PathAttributes) {}
    rpc getWorkingDirectory(FileSystem) returns (Path) {}
    rpc setWorkingDirectory(PathRequest) returns (Empty) {}
    rpc setPosixFilePermissions(SetPosixFilePermissionsRequest) returns (Empty) {}
    rpc readSymbolicLink(PathRequest) returns (Path) {}
    rpc isOpen(FileSystem) returns (Is) {}
    // Closes a filestem, any actions running it with this filestystem will be terminated, will also forget the filesystem
    // Any pending/running copy operations will be killed
    rpc close(FileSystem) returns (Empty) {}
    rpc waitUntilDone(WaitUntilDoneRequest) returns (CopyStatus) {}
    // Returns filesystems for all local drives
    rpc localFileSystems(Empty) returns (FileSystems) {}
    // List the created filesystems
    // Specific to grpc, not part of Xenon library
    rpc listFileSystems(Empty) returns (FileSystems) {}
}

// The Jobs API of Xenon. This interface creates various methods for creating and closing Schedulers, submitting jobs, and retrieving information about schedulers and jobs.
service SchedulerService {
    rpc getAdaptorDescriptions(Empty) returns (SchedulerAdaptorDescriptions) {}
    rpc getAdaptorDescription(AdaptorName) returns (SchedulerAdaptorDescription) {}
    rpc create(CreateSchedulerRequest) returns (Scheduler) {}
    rpc submitBatchJob(SubmitBatchJobRequest) returns (Job) {}
    // The first response message in the response stream will contain the job identifier and empty stdout and stdout.
    // Other response messages will also contain the job identifier and filled stdout and/or stderr.
    rpc submitInteractiveJob(stream SubmitInteractiveJobRequest) returns (stream SubmitInteractiveJobResponse) {}
    rpc getQueues(Scheduler) returns (Queues) {}
    rpc getDefaultQueueName(Scheduler) returns (Queue) {}
    rpc getJobs(SchedulerAndQueues) returns (Jobs) {}
    rpc getJobStatus(JobRequest) returns (JobStatus) {}
    rpc getJobStatuses(Jobs) returns (JobStatuses) {}
    rpc getQueueStatus(GetQueueStatusRequest) returns (QueueStatus) {}
    rpc getQueueStatuses(SchedulerAndQueues) returns (QueueStatuses) {}
    rpc waitUntilDone(WaitRequest) returns (JobStatus) {}
    rpc waitUntilRunning(WaitRequest) returns (JobStatus) {}
    rpc isOpen(Scheduler) returns (Is) {}
    rpc cancelJob(JobRequest) returns (JobStatus) {}
    // Close scheduler and forget it
    // If scheduler is embedded then any pending/running jobs will be killed
    rpc close(Scheduler) returns (Empty) {}
    rpc localScheduler(Empty) returns (Scheduler) {}
    // List the created schedulers
    // Specific to grpc, not part of Xenon library
    rpc listSchedulers(Empty) returns (Schedulers) {}
}


